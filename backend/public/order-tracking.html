<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Suivi de commande - TRIPLE SIEBEN</title>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex justify-center items-start p-4">
  <div class="bg-white rounded-2xl shadow-lg w-full max-w-md p-6 flex flex-col items-center">
    <img src="/assets/logo.png" alt="Logo TRIPLE SIEBEN" class="w-40 mb-4" />
    <h1 id="headerTitle" class="text-xl font-semibold text-gray-800 text-center mb-3">Suivi de la commande</h1>
    <div id="animatedMsg" class="text-gray-600 italic min-h-[1.5rem] mb-6 text-center overflow-hidden border-r-2 border-blue-500"></div>

    <!-- Barre de progression -->
    <div id="progressBar" class="w-full mb-6 relative flex items-center justify-between">
      <div class="absolute top-1/2 left-0 right-0 h-1 bg-gray-300 transform -translate-y-1/2 rounded-full"></div>
    </div>

    <!-- Détails de la commande -->
    <div id="orderDetails" class="w-full bg-gray-50 rounded-xl p-4 shadow-inner hidden mb-6"></div>

    <!-- Buttons -->
    <div class="w-full flex flex-col sm:flex-row gap-4">
      <button id="refreshBtn" class="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-semibold py-3 rounded-xl transition">Rafraîchir</button>
      <button id="userDashboardBtn" class="flex-1 bg-gray-800 hover:bg-gray-900 text-white font-semibold py-3 rounded-xl transition">Mon espace client</button>
    </div>

    <div id="error" class="text-red-600 mt-4 min-h-[1.25rem] text-center"></div>
  </div>

  <script>
    // ✅ Utilisation de l'API relative
    const API_BASE = "/api"; // <-- ici le chemin relatif
    const orderId = new URLSearchParams(window.location.search).get('orderId');
    const token = localStorage.getItem('token');
    const progressBar = document.getElementById('progressBar');
    const errorEl = document.getElementById('error');
    const refreshBtn = document.getElementById('refreshBtn');
    const userDashboardBtn = document.getElementById('userDashboardBtn');
    const animatedMsgEl = document.getElementById('animatedMsg');
    const headerTitle = document.getElementById('headerTitle');

    const steps = ["reçue", "en préparation", "prête", "livrée"];

    if (!orderId) {
      progressBar.innerHTML = '<div class="text-red-500 font-semibold text-center w-full">Aucune commande spécifiée.</div>';
      throw new Error("orderId manquant dans l'URL");
    }

    async function fetchUserInfo() {
      try {
        const res = await fetch(`${API_BASE}/users/me`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!res.ok) throw new Error("Utilisateur non connecté");
        const user = await res.json();
        const nameToDisplay = user.fullName || user.username || "Client";
        headerTitle.textContent = `Bonjour ${nameToDisplay}, suivi de la commande n°${orderId}`;
      } catch {
        headerTitle.textContent = `Suivi de la commande n°${orderId}`;
      }
    }

    const messages = [
      "Merci de votre confiance, votre commande est entre de bonnes mains !",
      "Suivez l'avancement de votre commande en temps réel.",
      "N'hésitez pas à rafraîchir ou revenir à votre espace client.",
      "Votre satisfaction est notre priorité chez TRIPLE SIEBEN."
    ];

    let msgIndex = 0;
    let charIndex = 0;
    let deleting = false;

    function typeEffect() {
      const currentMsg = messages[msgIndex];
      if (!deleting) {
        animatedMsgEl.textContent = currentMsg.slice(0, charIndex + 1);
        charIndex++;
        if (charIndex === currentMsg.length) {
          deleting = true;
          setTimeout(typeEffect, 2000);
          return;
        }
      } else {
        animatedMsgEl.textContent = currentMsg.slice(0, charIndex - 1);
        charIndex--;
        if (charIndex === 0) {
          deleting = false;
          msgIndex = (msgIndex + 1) % messages.length;
        }
      }
      setTimeout(typeEffect, deleting ? 50 : 100);
    }

    function renderProgressBar(currentStatus) {
      progressBar.innerHTML = '';
      steps.forEach((step, idx) => {
        const isActive = steps.indexOf(step) <= steps.indexOf(currentStatus);
        const leftPercent = (idx / (steps.length - 1)) * 100;

        const circle = document.createElement('div');
        circle.className = `absolute transform -translate-x-1/2 -translate-y-1/2 w-6 h-6 rounded-full flex items-center justify-center text-white font-semibold transition-colors duration-500 ${isActive ? 'bg-yellow-400' : 'bg-gray-300'}`;
        circle.style.left = `${leftPercent}%`;
        circle.textContent = idx + 1;

        const label = document.createElement('span');
        label.className = `absolute mt-6 text-xs font-medium ${isActive ? 'text-gray-800' : 'text-gray-400'}`;
        label.style.left = `${leftPercent}%`;
        label.style.transform = 'translateX(-50%)';
        label.textContent = step.charAt(0).toUpperCase() + step.slice(1);

        progressBar.appendChild(circle);
        progressBar.appendChild(label);
      });

      const activeSteps = steps.indexOf(currentStatus);
      const line = document.createElement('div');
      line.className = 'absolute top-1/2 h-1 bg-yellow-400 rounded-full transition-all duration-500';
      line.style.left = '0';
      line.style.width = `${(activeSteps / (steps.length - 1)) * 100}%`;
      progressBar.appendChild(line);
    }

    function renderOrderDetails(order) {
      const container = document.getElementById("orderDetails");
      if (!order.items || order.items.length === 0) {
        container.classList.add("hidden");
        return;
      }

      let total = 0;
      const listItems = order.items.map(item => {
        const quantity = item.quantity || 1;
        const price = item.price || 0;
        total += quantity * price;
        return `<li class="flex justify-between py-1 border-b border-dotted border-gray-300">${quantity}x ${item.name}<span>${(quantity*price).toFixed(2)} €</span></li>`;
      }).join('');

      container.innerHTML = `
        <h2 class="font-semibold text-gray-800 mb-2 border-b border-gray-300 pb-1">Détails de la commande</h2>
        <ul>${listItems}</ul>
        <div class="text-right font-semibold mt-2">Total : ${total.toFixed(2)} €</div>
      `;
      container.classList.remove("hidden");
    }

    async function fetchOrderStatus() {
      refreshBtn.disabled = true;
      try {
        const res = await fetch(`${API_BASE}/orders/${orderId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!res.ok) throw new Error("Commande introuvable ou erreur serveur");
        const data = await res.json();
        renderProgressBar(data.status);
        renderOrderDetails(data);
        errorEl.textContent = '';
      } catch (err) {
        errorEl.textContent = err.message || "Erreur lors de la récupération du statut.";
      } finally {
        refreshBtn.disabled = false;
      }
    }

    typeEffect();
    fetchUserInfo();
    fetchOrderStatus();

    const socket = io({ auth: { token } });
    socket.on(`order-status-${orderId}`, (data) => {
      if (data.status) {
        renderProgressBar(data.status);
      }
    });

    refreshBtn.addEventListener('click', fetchOrderStatus);
    userDashboardBtn.addEventListener('click', () => {
      window.location.href = '/user-dashboard.html';
    });
  </script>
</body>
</html>
