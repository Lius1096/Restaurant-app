<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Suivi de commande - TRIPLE SIEBEN</title>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes blink {
      50% { border-color: transparent; }
    }
    #animatedMsg {
      white-space: nowrap;
      border-right: 2px solid #F97316;
      animation: blink 1s infinite;
    }
    .node-line {
      position: absolute;
      top: 50%;
      left: 0;
      height: 3px;
      transform: translateY(-50%);
      border-radius: 2px;
    }
    .circuit-node {
      position: absolute;
      top: 50%;
      transform: translate(-50%, -50%);
    }
  </style>
</head>
<body class="bg-white min-h-screen flex justify-center items-start p-6">
  <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 flex flex-col items-center border border-neutral-800">
    <img src="/assets/logo.png" alt="Logo TRIPLE SIEBEN" class="w-32 mb-4" />
    <h1 id="headerTitle" class="text-lg font-semibold text-black text-center mb-2">Suivi de la commande</h1>
    <div id="animatedMsg" class="text-gray-400 italic mb-6 text-center min-h-[1.5rem]"></div>

    <!-- Barre de progression style circuit -->
    <div id="progressBar" class="relative w-full h-24 flex items-center justify-between mb-6"></div>

    <!-- Statut -->
    <div id="orderStatus" class="text-center mb-6 hidden"></div>

    <!-- D√©tails commande -->
    <div id="orderDetails" class="w-full bg-neutral-800 rounded-xl p-4 shadow-inner hidden mb-6 text-white"></div>

    <!-- Buttons -->
    <div class="w-full flex flex-col sm:flex-row gap-4">
      <button id="refreshBtn" class="flex-1 bg-orange-500 hover:bg-orange-600 text-black font-semibold py-3 rounded-xl transition"> Rafra√Æchir</button>
      <button id="userDashboardBtn" class="flex-1 bg-black border border-orange-500 hover:bg-orange-600 hover:text-black text-orange-400 font-semibold py-3 rounded-xl transition"> Espace client</button>
    </div>

    <div id="error" class="text-orange-400 mt-4 min-h-[1.25rem] text-center"></div>
  </div>

  <script>
    const API_BASE = "/api";
    const orderId = new URLSearchParams(window.location.search).get('orderId');
    const token = localStorage.getItem('token');
    const progressBar = document.getElementById('progressBar');
    const orderStatusEl = document.getElementById('orderStatus');
    const errorEl = document.getElementById('error');
    const refreshBtn = document.getElementById('refreshBtn');
    const userDashboardBtn = document.getElementById('userDashboardBtn');
    const animatedMsgEl = document.getElementById('animatedMsg');
    const headerTitle = document.getElementById('headerTitle');

    const steps = ["pending", "modified", "confirmed", "preparing", "ready", "completed", "cancelled"];
    const stepLabels = {
      pending: "En attente",
      modified: "Modifi√©e",
      confirmed: "Confirm√©e",
      preparing: "Pr√©paration",
      ready: "Pr√™te",
      completed: "Termin√©e",
      cancelled: "Annul√©e"
    };

    if (!orderId) {
      progressBar.innerHTML = '<div class="text-orange-400 font-semibold text-center w-full">Aucune commande sp√©cifi√©e.</div>';
      throw new Error("orderId manquant dans l'URL");
    }

    async function fetchUserInfo() {
      try {
        const res = await fetch(`${API_BASE}/users/me`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!res.ok) throw new Error("Utilisateur non connect√©");
        const user = await res.json();
        const nameToDisplay = user.fullName || user.username || "Client";
        headerTitle.textContent = `Bonjour ${nameToDisplay}, suivi de la commande n¬∞${orderId}`;
      } catch {
        headerTitle.textContent = `Suivi de la commande n¬∞${orderId}`;
      }
    }

    const messages = [
      "Merci pour votre confiance üß°",
      "Suivez l'√©volution de votre commande en direct",
      "Votre satisfaction est notre priorit√© chez TRIPLE SIEBEN "
    ];
    let msgIndex = 0, charIndex = 0, deleting = false;
    function typeEffect() {
      const currentMsg = messages[msgIndex];
      animatedMsgEl.textContent = currentMsg.slice(0, charIndex + (deleting ? -1 : 1));
      charIndex += deleting ? -1 : 1;

      if (!deleting && charIndex === currentMsg.length) {
        deleting = true;
        setTimeout(typeEffect, 2000);
        return;
      }
      if (deleting && charIndex === 0) {
        deleting = false;
        msgIndex = (msgIndex + 1) % messages.length;
      }
      setTimeout(typeEffect, deleting ? 40 : 70);
    }

    function renderProgressBar(currentStatus) {
      progressBar.innerHTML = '';
      const isCancelled = currentStatus === 'cancelled';
      const activeSteps = steps.indexOf(currentStatus);

      // Ligne principale (circuit)
      const line = document.createElement('div');
      line.className = 'node-line w-full bg-neutral-700';
      progressBar.appendChild(line);

      // Ligne de progression
      const progressLine = document.createElement('div');
      progressLine.className = `node-line bg-orange-500 transition-all duration-700`;
      progressLine.style.width = isCancelled ? '100%' : `${(activeSteps / (steps.length - 2)) * 100}%`;
      progressBar.appendChild(progressLine);

      steps.forEach((step, idx) => {
        const leftPercent = (idx / (steps.length - 1)) * 100;
        const isActive = steps.indexOf(step) <= steps.indexOf(currentStatus) && !isCancelled;

        const node = document.createElement('div');
        node.className = `circuit-node w-8 h-8 rounded-full border-2 flex items-center justify-center text-sm font-semibold ${
          isCancelled && step === 'cancelled'
            ? 'border-red-600 bg-red-800 text-red-400'
            : isActive
            ? 'border-orange-500 bg-orange-500 text-black shadow-lg'
            : 'border-neutral-600 bg-neutral-800 text-neutral-500'
        }`;
        node.style.left = `${leftPercent}%`;
        node.textContent = idx + 1;

        const label = document.createElement('div');
        label.className = `absolute text-xs text-center w-20 mt-12 -translate-x-1/2 ${
          isActive ? 'text-orange-400' : 'text-neutral-500'
        }`;
        label.style.left = `${leftPercent}%`;
        label.textContent = stepLabels[step];

        progressBar.appendChild(node);
        progressBar.appendChild(label);
      });

      // Texte de statut
      orderStatusEl.classList.remove("hidden");
      if (isCancelled) {
        orderStatusEl.innerHTML = `
          <div class="inline-block px-4 py-1 bg-red-800 border border-red-600 text-red-400 font-semibold rounded-full">
             Commande annul√©e
          </div>
          <p class="text-sm text-neutral-400 mt-1">Contactez-nous pour toute assistance.</p>
        `;
      } else if (currentStatus === "completed") {
        orderStatusEl.innerHTML = `
          <div class="inline-block px-4 py-1 bg-orange-500 text-black font-semibold rounded-full">
             Commande termin√©e
          </div>
          <p class="text-sm text-neutral-400 mt-1">Merci pour votre confiance.</p>
        `;
      } else {
        orderStatusEl.innerHTML = `
          <div class="inline-block px-4 py-1 border border-orange-500 text-orange-400 font-semibold rounded-full">
             Statut : ${stepLabels[currentStatus] || "En attente"}
          </div>
        `;
      }
    }

    function renderOrderDetails(order) {
      const container = document.getElementById("orderDetails");
      if (!order.items || order.items.length === 0) {
        container.classList.add("hidden");
        return;
      }

      let total = 0;
      const listItems = order.items.map(item => {
        const quantity = item.quantity || 1;
        const price = item.price || 0;
        total += quantity * price;
        return `<li class="flex justify-between py-1 border-b border-neutral-700">${quantity}x ${item.name}<span>${(quantity*price).toFixed(2)} ‚Ç¨</span></li>`;
      }).join('');

      container.innerHTML = `
        <h2 class="font-semibold text-orange-400 mb-2 border-b border-neutral-700 pb-1">D√©tails de la commande</h2>
        <ul>${listItems}</ul>
        <div class="text-right font-semibold mt-2 text-orange-400">Total : ${total.toFixed(2)} ‚Ç¨</div>
      `;
      container.classList.remove("hidden");
    }

    async function fetchOrderStatus() {
      refreshBtn.disabled = true;
      try {
        const res = await fetch(`${API_BASE}/orders/my`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!res.ok) throw new Error("Impossible de r√©cup√©rer vos commandes");
        const orders = await res.json();
        const order = orders.find(o => o._id === orderId || o.orderId === orderId);
        if (!order) throw new Error("Commande introuvable");
        renderProgressBar(order.status);
        renderOrderDetails(order);
        errorEl.textContent = '';
      } catch (err) {
        errorEl.textContent = err.message || "Erreur lors de la r√©cup√©ration du statut.";
      } finally {
        refreshBtn.disabled = false;
      }
    }

    // --- Initialisation ---
    typeEffect();
    fetchUserInfo();
    fetchOrderStatus();

    // --- WebSocket temps r√©el ---
    const socket = io({ auth: { token } });
    socket.emit('joinOrder', orderId);
    socket.on('orderUpdated', fetchOrderStatus);
    socket.on(`order-status-${orderId}`, (data) => {
      if (data.status) renderProgressBar(data.status);
    });

    refreshBtn.addEventListener('click', fetchOrderStatus);
    userDashboardBtn.addEventListener('click', () => {
      window.location.href = '/user-dashboard.html';
    });
  </script>
</body>
</html>
