<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Suivi de commande</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f9fafb;
      margin: 0;
      padding: 2rem;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }

    .container {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      max-width: 480px;
      width: 100%;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    img.logo {
      max-width: 180px;
      margin: 0 auto 1.5rem auto;
      display: block;
    }

    h1 {
      font-size: 1.6rem;
      margin-bottom: 0.4rem;
      color: #333;
    }

    .animated-message {
      font-style: italic;
      color: hsl(44, 100%, 50%);
      min-height: 1.3em;
      margin-bottom: 2rem;
      white-space: nowrap;
      overflow: hidden;
      border-right: 2px solid #007bff;
      font-weight: 500;
      font-size: 1.1rem;
      user-select: none;
    }

    .timeline {
      margin: 2rem 0;
      padding-left: 1rem;
      border-left: 4px solid #ccc;
      text-align: left;
    }

    .step {
      margin-bottom: 1.2rem;
      position: relative;
      padding-left: 1rem;
      color: #666;
    }

    .step::before {
      content: "";
      position: absolute;
      left: -11px;
      top: 4px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #ccc;
    }

    .step.active {
      font-weight: bold;
      color: #222;
    }

    .step.active::before {
      background: #fdc407;
    }

    .refresh-btn,
    .user-dashboard-btn {
      background: hsl(32, 98%, 50%);
      color: hwb(0 100% 0%);
      border: none;
      padding: 0.6rem 1.4rem;
      font-size: 1rem;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s ease;
      margin: 0.3rem auto;
      display: block;
      min-width: 220px;
      user-select: none;
    }

    .refresh-btn:hover,
    .user-dashboard-btn:hover {
      background: hsl(0, 4%, 5%);
      color: white;
    }

    .error {
      color: red;
      margin-top: 1rem;
      min-height: 1.2em;
    }

    .order-details {
      margin-top: 2rem;
      padding: 1rem;
      background: #f9fafb;
      border-radius: 12px;
      box-shadow: inset 0 0 0 1px #e5e7eb;
      text-align: left;
    }

    .order-details h2 {
      margin-bottom: 0.5rem;
      font-size: 1.1rem;
      color: #111;
      border-bottom: 1px solid #ddd;
      padding-bottom: 0.5rem;
    }

    .order-details ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .order-details li {
      display: flex;
      justify-content: space-between;
      padding: 0.4rem 0;
      border-bottom: 1px dotted #ddd;
      font-size: 0.95rem;
    }

    .order-details li:last-child {
      border-bottom: none;
    }

    .order-details .total {
      font-weight: bold;
      font-size: 1rem;
      margin-top: 0.75rem;
      text-align: right;
    }

    .hidden {
      display: none;
    }
  </style>
</head>

<body>
  <div class="container">
    <img src="/assets/logo.png" alt="Logo TRIPLE SIEBEN" class="logo" />
    <h1 id="headerTitle">Suivi de commande</h1>
    <div id="animatedMsg" class="animated-message"></div>

    <div id="statusTimeline" class="timeline"></div>

    <div id="orderDetails" class="order-details hidden"></div>

    <button class="refresh-btn" id="refreshBtn">Rafraîchir manuellement</button>
    <button class="user-dashboard-btn" id="userDashboardBtn">Mon espace client</button>

    <div id="error" class="error"></div>
  </div>

  <script>
    const API_BASE = "http://localhost:5000";
    const orderId = new URLSearchParams(window.location.search).get('orderId');
    const token = localStorage.getItem('token');
    const timelineEl = document.getElementById('statusTimeline');
    const errorEl = document.getElementById('error');
    const refreshBtn = document.getElementById('refreshBtn');
    const userDashboardBtn = document.getElementById('userDashboardBtn');
    const animatedMsgEl = document.getElementById('animatedMsg');
    const headerTitle = document.getElementById('headerTitle');

    const steps = ["reçue", "en préparation", "prête", "livrée"];

    if (!orderId) {
      timelineEl.innerHTML = '<div class="step error">Aucune commande spécifiée.</div>';
      throw new Error("orderId manquant dans l'URL");
    }

    async function fetchUserInfo() {
      try {
        const res = await fetch(`${API_BASE}/api/users/me`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!res.ok) throw new Error("Utilisateur non connecté");
        const user = await res.json();
        const nameToDisplay = user.fullName || user.username || "Client";
        headerTitle.textContent = `Bonjour ${nameToDisplay}, suivi de la commande n°${orderId}`;
      } catch (err) {
        console.warn("Erreur utilisateur :", err.message);
        headerTitle.textContent = `Suivi de la commande n°${orderId}`;
      }
    }

    const messages = [
      "Merci de votre confiance, votre commande est entre de bonnes mains !",
      "Suivez l'avancement de votre commande en temps réel.",
      "N'hésitez pas à rafraîchir ou revenir à votre espace client.",
      "Votre satisfaction est notre priorité chez TRIPLE SIEBEN."
    ];

    let msgIndex = 0;
    let charIndex = 0;
    let deleting = false;

    function typeEffect() {
      const currentMsg = messages[msgIndex];
      if (!deleting) {
        animatedMsgEl.textContent = currentMsg.slice(0, charIndex + 1);
        charIndex++;
        if (charIndex === currentMsg.length) {
          deleting = true;
          setTimeout(typeEffect, 2000);
          return;
        }
      } else {
        animatedMsgEl.textContent = currentMsg.slice(0, charIndex - 1);
        charIndex--;
        if (charIndex === 0) {
          deleting = false;
          msgIndex = (msgIndex + 1) % messages.length;
        }
      }
      setTimeout(typeEffect, deleting ? 50 : 100);
    }

    function renderTimeline(currentStatus) {
      timelineEl.innerHTML = steps.map(step => {
        const isActive = steps.indexOf(step) <= steps.indexOf(currentStatus);
        return `<div class="step${isActive ? ' active' : ''}">${step.charAt(0).toUpperCase() + step.slice(1)}</div>`;
      }).join('');
    }

    function renderOrderDetails(order) {
      const container = document.getElementById("orderDetails");
      if (!order.items || order.items.length === 0) {
        container.classList.add("hidden");
        return;
      }

      let total = 0;
      const listItems = order.items.map(item => {
        const quantity = item.quantity || 1;
        const price = item.price || 0;
        total += quantity * price;
        return `<li><span>${quantity}x ${item.name}</span><span>${(quantity * price).toFixed(2)} €</span></li>`;
      }).join('');

      container.innerHTML = `
        <h2>Détails de la commande</h2>
        <ul>${listItems}</ul>
        <div class="total">Total : ${total.toFixed(2)} €</div>
      `;
      container.classList.remove("hidden");
    }

    async function fetchOrderStatus() {
      refreshBtn.disabled = true;
      try {
        const res = await fetch(`${API_BASE}/api/orders/${orderId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!res.ok) throw new Error("Commande introuvable ou erreur serveur");
        const data = await res.json();
        renderTimeline(data.status);
        renderOrderDetails(data);
        errorEl.textContent = '';
      } catch (err) {
        console.error("Erreur fetchOrderStatus:", err);
        errorEl.textContent = err.message || "Erreur lors de la récupération du statut.";
      } finally {
        refreshBtn.disabled = false;
      }
    }

    typeEffect();
    fetchUserInfo();
    fetchOrderStatus();

    const socket = io({ auth: { token } });
    socket.on(`order-status-${orderId}`, (data) => {
      if (data.status) {
        renderTimeline(data.status);
      }
    });

    refreshBtn.addEventListener('click', fetchOrderStatus);
    userDashboardBtn.addEventListener('click', () => {
      window.location.href = '/user-dashboard.html';
    });
  </script>
</body>
</html>
