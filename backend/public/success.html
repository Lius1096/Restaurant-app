<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Confirmation de paiement - TRIPLE SIEBEN</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gradient-to-b from-gray-50 to-gray-100 flex items-center justify-center min-h-screen p-4">
  <main id="main"
    class="bg-white max-w-lg w-full p-8 rounded-2xl shadow-xl border-t-4 border-orange-500 text-center animate-fadeIn"
    role="main" aria-live="polite" aria-busy="true" aria-label="Confirmation de paiement">
    <h1 class="text-3xl font-extrabold text-gray-800 mb-2">Paiement confirmé</h1>

    <section id="confirmation" aria-describedby="desc-msg" tabindex="-1">
      <p id="desc-msg" class="text-gray-600 mb-6">Récupération des détails de la commande...</p>
    </section>

    <div class="flex justify-center mb-6">
      <svg class="animate-spin h-12 w-12 text-orange-500" xmlns="http://www.w3.org/2000/svg" fill="none"
        viewBox="0 0 24 24" aria-hidden="true">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4l3-3-3-3v4a8 8 0 00-8 8h4l-3 3 3 3H4z">
        </path>
      </svg>
    </div>

    <footer class="text-gray-500 text-sm mt-6">
      © <span class="font-semibold text-orange-600">TRIPLE SIEBEN</span> — Merci pour votre confiance.
    </footer>
  </main>

  <script>
    (function () {
      const BASE_API = "http://localhost:5000";
      const FRONT_URL = window.location.origin;
      const params = new URLSearchParams(window.location.search);
      const sessionId = params.get("session_id");

      const confirmationEl = document.getElementById("confirmation");
      const mainContainer = document.getElementById("main");
      const spinner = mainContainer.querySelector("svg");

      function setBusy(isBusy) {
        mainContainer.setAttribute("aria-busy", isBusy ? "true" : "false");
      }

      if (!sessionId) {
        confirmationEl.innerHTML = `
          <div class="bg-red-50 text-red-700 font-semibold p-4 rounded mb-4" role="alert" tabindex="0">
            Aucun identifiant de session trouvé dans l'URL.
          </div>
        `;
        spinner.style.display = "none";
        setBusy(false);
        confirmationEl.focus();
        return;
      }

      fetch(`${BASE_API}/api/payment/session/${sessionId}`)
        .then((res) => {
          if (!res.ok) throw new Error("Erreur lors de la récupération de la session");
          return res.json();
        })
        .then((data) => {
          const orderId = data.orderId || data.id || sessionId;
          const amount = ((data.amount_total || data.amount || 0) / 100).toFixed(2);
          const dashboardUrl = `${FRONT_URL}/user-dashboard?order=${encodeURIComponent(orderId)}`;

          confirmationEl.innerHTML = `
            <h2 class="text-2xl font-semibold text-gray-800 mb-2">Merci pour votre commande !</h2>
            <p class="mb-1 text-gray-700">Montant payé : <strong>${amount} €</strong></p>

            <p class="mt-2 text-sm text-gray-600">Numéro de commande :</p>
            <span class="inline-block bg-orange-500 text-white font-semibold py-1 px-3 rounded-full my-2">${orderId}</span>

            <div class="border-t-2 border-dashed border-gray-200 my-4"></div>

            <div id="qrcode-container" class="mb-4 text-center">
  <a href="/order-tracking.html?orderId=${encodeURIComponent(orderId)}" target="_blank" rel="noopener noreferrer">
    <img 
      class="mx-auto w-24 h-24 sm:w-28 sm:h-28 rounded-lg border border-gray-200 p-1 shadow-sm transition-transform hover:scale-105"
      src="https://api.qrserver.com/v1/create-qr-code/?data=${encodeURIComponent(dashboardUrl)}&size=200x200"
      alt="QR Code vers votre suivi de commande"
    />
  </a>
  <p class="mt-2 text-gray-600 text-sm">Scannez ou cliquez pour suivre la commande</p>
</div>


            <!-- Lieu de retrait stylé -->
            <div class="bg-gray-50 p-4 rounded-lg shadow-sm text-left mb-4">
              <p class="text-sm font-semibold text-gray-800">Lieu de retrait</p>
              <p class="text-sm text-gray-600">TRIPLE SIEBEN — Carré 350 Sénadé, Cotonou</p>
              <a href="https://www.google.com/maps/search/Carr%C3%A9+350+S%C3%A9nad%C3%A9+Cotonou" target="_blank" rel="noopener noreferrer" class="inline-block mt-2 text-xs underline">Ouvrir dans Maps</a>
            </div>

            <!-- Boutons alignés horizontalement sur desktop et full-width sur mobile -->
            <div class="flex flex-col sm:flex-row justify-center items-center gap-3 mt-4">
              <a href="${dashboardUrl}" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-2 bg-orange-500 hover:bg-orange-600 text-white font-semibold py-3 px-6 rounded-full transition-shadow shadow w-full sm:w-auto justify-center">Tableau de bord</a>

              <button id="download-ticket" class="inline-flex items-center gap-2 bg-gray-900 hover:bg-gray-800 text-white font-semibold py-3 px-6 rounded-full transition-shadow shadow w-full sm:w-auto justify-center">Télécharger mon ticket</button>
            </div>

            <p class="text-xs text-gray-500 mt-3">Vous recevrez un e-mail récapitulatif. Conservez votre numéro de commande pour toute demande.</p>
          `;

          spinner.style.display = "none";
          setBusy(false);
          confirmationEl.focus();

          document.getElementById("download-ticket").addEventListener("click", () => {
            const link = document.createElement("a");
            link.href = `${BASE_API}/api/ticket/${orderId}`;
            link.download = `ticket-${orderId}.pdf`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          });
        })
        .catch((err) => {
          console.error(err);
          confirmationEl.innerHTML = `
            <div class="bg-red-50 text-red-700 font-semibold p-4 rounded mb-4" role="alert" tabindex="0">
              Impossible de récupérer les informations de la commande. Veuillez réessayer plus tard.
            </div>
          `;
          spinner.style.display = "none";
          setBusy(false);
          confirmationEl.focus();
        });
    })();
  </script>

  <style>
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-fadeIn {
      animation: fadeIn 0.6s ease forwards;
    }
  </style>
</body>

</html>