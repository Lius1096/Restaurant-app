<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Utilisateur</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
  <style>
    .avatar-placeholder {
      @apply w-24 h-24 rounded-full bg-gray-300 flex items-center justify-center text-gray-500 font-bold text-2xl select-none;
    }
    #notificationCount {
      @apply bg-red-500 text-white text-xs py-0.5 px-2 rounded-full absolute -top-1 -right-1;
    }
  </style>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col md:flex-row">
  <!-- Sidebar -->
  <aside class="w-full md:w-64 bg-white shadow-md flex-shrink-0">
    <div class="p-6 border-b text-center">
      <img id="userPhoto" alt="Photo Profil" class="w-24 h-24 rounded-full mb-2 object-cover hidden mx-auto" />
      <div id="userPhotoPlaceholder" class="avatar-placeholder mx-auto mb-2">U</div>
      <h2 id="userName" class="text-xl font-bold">Nom utilisateur</h2>
      <p id="userEmail" class="text-gray-500 text-sm">email@example.com</p>
    </div>
    <nav class="p-4">
      <ul class="space-y-3">
        <li>
          <button onclick="showSection('ordersSection')" class="w-full text-left hover:bg-gray-200 p-2 rounded">Mes commandes</button>
        </li>
        <li>
          <button onclick="showSection('profileSection')" class="w-full text-left hover:bg-gray-200 p-2 rounded">Mon profil</button>
        </li>
        <li>
          <a href="index.html#menu" class="block w-full text-left hover:bg-gray-200 p-2 rounded">Passer une commande</a>
        </li>
        <li>
          <button onclick="logout()" class="w-full text-left text-red-600 hover:bg-red-100 p-2 rounded">Déconnexion</button>
        </li>
      </ul>
    </nav>
  </aside>

  <!-- Main -->
  <main class="flex-1 p-4 md:p-6 overflow-auto">
    <!-- Notification Bell -->
    <section id="notifications" class="mb-6">
      <div class="flex justify-end">
        <button id="notificationButton" class="relative" aria-label="Afficher les notifications">
          <svg class="w-8 h-8 text-gray-700 hover:text-black" fill="none" stroke="currentColor" stroke-width="2"
            viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C8.67 6.165 8 7.388 8 9v5.159c0 .538-.214 1.055-.595 1.436L6 17h5m4 0v1a3 3 0 11-6 0v-1m6 0H9" />
          </svg>
          <span id="notificationCount" class="hidden">0</span>
        </button>
        <div id="notificationList"
          class="absolute right-4 top-14 bg-white shadow-xl rounded-md w-72 max-h-72 overflow-hidden hidden z-50">
          <div class="sticky top-0 bg-white border-b border-gray-200 p-3 font-semibold text-gray-700">Notifications</div>
          <ul id="notifications-container" class="max-h-60 overflow-y-auto divide-y divide-gray-200"></ul>
          <div id="noNotifications" class="p-4 text-center text-gray-500 text-sm hidden">Aucune notification.</div>
        </div>
      </div>
    </section>

    <!-- Orders Section -->
    <section id="ordersSection" class="block">
      <h1 class="text-2xl md:text-3xl font-bold mb-6">Mes commandes</h1>
      <div id="ordersList" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3"></div>
    </section>

    <!-- Profile Section -->
    <section id="profileSection" class="hidden max-w-2xl">
      <h1 class="text-2xl md:text-3xl font-bold mb-6">Mon profil</h1>
      <form id="profileForm" class="bg-white p-6 rounded shadow space-y-4" enctype="multipart/form-data">
        <div class="flex flex-col items-center">
          <img id="profilePhotoPreview" alt="Photo Profil" class="w-28 h-28 rounded-full mb-4 object-cover hidden" />
          <div id="profilePhotoPlaceholder" class="avatar-placeholder mb-4">U</div>
          <input type="file" id="profilePhoto" accept="image/*" class="block w-full text-sm text-gray-500" />
        </div>
        <div>
          <label class="block mb-1 font-semibold" for="username">Nom d’utilisateur</label>
          <input id="username" type="text"
            class="w-full border rounded px-3 py-2 focus:outline-none focus:ring focus:ring-blue-200" required />
        </div>
        <div>
          <label class="block mb-1 font-semibold" for="email">Email</label>
          <input id="email" type="email"
            class="w-full border rounded px-3 py-2 focus:outline-none focus:ring focus:ring-blue-200" required />
        </div>
        <div>
          <label class="block mb-1 font-semibold" for="password">Nouveau mot de passe</label>
          <input id="password" type="password"
            class="w-full border rounded px-3 py-2 focus:outline-none focus:ring focus:ring-blue-200"
            placeholder="Laissez vide pour ne pas changer" />
        </div>
        <button type="submit"
          class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400">Sauvegarder</button>
      </form>
      <div id="profileMsg" class="mt-4 text-green-600 font-semibold"></div>
    </section>
  </main>

   <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
  const token = localStorage.getItem("token");

  const socket = io("http://localhost:5000", {
    auth: {
      token: token
    },
    autoConnect: false
  });

  // Important : réinjecter le token à chaque reconnexion
  socket.io.on("reconnect_attempt", () => {
    socket.auth.token = localStorage.getItem("token");
  });

  socket.connect();

  socket.on("connect", () => {
    console.log("✅ Socket connecté avec succès :", socket.id);
  });

  socket.on("connect_error", (err) => {
    console.error("❌ Erreur de connexion socket :", err.message);
  });

  // Tu peux aussi exposer le socket pour les autres modules
  window.userSocket = socket;
</script>


  <script>
    const API_BASE = 'http://localhost:5000/api';
    let userData = null;
    let userOrders = [];
    let currentOrder = null;

    function showSection(id) {
      document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
    }

    async function fetchUser() {
      try {
        const res = await fetch(`${API_BASE}/users/me`, {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        if (!res.ok) {
          logout();
          return;
        }
        userData = await res.json();
        updateProfileUI();
      } catch (e) {
        console.error('Erreur fetchUser:', e);
        logout();
      }
    }

    // Gère affichage avatar ou placeholder
    function updateProfileUI() {
      if (!userData) return;

      // Sidebar
      if (userData.photo) {
        document.getElementById('userPhoto').src = userData.photo;
        document.getElementById('userPhoto').classList.remove('hidden');
        document.getElementById('userPhotoPlaceholder').classList.add('hidden');
      } else {
        document.getElementById('userPhoto').classList.add('hidden');
        document.getElementById('userPhotoPlaceholder').classList.remove('hidden');
        document.getElementById('userPhotoPlaceholder').textContent = (userData.username[0] || 'U').toUpperCase();
      }
      document.getElementById('userName').textContent = userData.username;
      document.getElementById('userEmail').textContent = userData.email;

      // Profil form
      if (userData.photo) {
        document.getElementById('profilePhotoPreview').src = userData.photo;
        document.getElementById('profilePhotoPreview').classList.remove('hidden');
        document.getElementById('profilePhotoPlaceholder').classList.add('hidden');
      } else {
        document.getElementById('profilePhotoPreview').classList.add('hidden');
        document.getElementById('profilePhotoPlaceholder').classList.remove('hidden');
        document.getElementById('profilePhotoPlaceholder').textContent = (userData.username[0] || 'U').toUpperCase();
      }
      document.getElementById('username').value = userData.username;
      document.getElementById('email').value = userData.email;
    }

    async function fetchOrders() {
      try {
        const res = await fetch(`${API_BASE}/orders`, {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        if (!res.ok) {
          console.error('Erreur fetchOrders:', res.statusText);
          document.getElementById('ordersList').innerHTML = '<p class="text-gray-600">Erreur lors de la récupération des commandes.</p>';
          return;
        }
        userOrders = await res.json();
        displayOrders();
      } catch (e) {
        console.error('Erreur fetchOrders:', e);
        document.getElementById('ordersList').innerHTML = '<p class="text-gray-600">Erreur serveur.</p>';
      }
    }

    // function displayOrders() {
    //   const container = document.getElementById('ordersList');
    //   container.innerHTML = '';
    //   if (!userOrders.length) {
    //     container.innerHTML = '<p class="text-gray-600">Aucune commande.</p>';
    //     return;
    //   }
    //   userOrders.forEach(order => {
    //     const div = document.createElement('div');
    //     div.className = 'bg-white p-4 rounded shadow flex justify-between items-center';
    //     div.innerHTML = `
    //       <div>
    //         <p><strong>Commande :</strong> <span class="font-mono">${order.orderId || order._id}</span></p>
    //         <p><strong>Statut :</strong> <span class="capitalize">${order.status}</span></p>
    //         <p><strong>Heure :</strong> ${order.pickupTime || '-'}</p>
    //       </div>
    //       <button class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded" onclick="openOrderDetail('${order._id}')">Détails</button>
    //     `;
    //     container.appendChild(div);
    //   });
    // }

    function displayOrders() {
  const container = document.getElementById('ordersList');
  container.innerHTML = '';

  if (!userOrders.length) {
    container.innerHTML = '<p class="text-gray-600">Aucune commande.</p>';
    return;
  }

  userOrders.forEach(order => {
    const orderId = order.orderId || order._id;
    const div = document.createElement('div');
    div.className = 'bg-white p-4 rounded shadow';

    div.innerHTML = `
      <div class="flex justify-between items-center">
        <div>
          <p><strong>Commande :</strong> <span class="font-mono">${orderId}</span></p>
          <p><strong>Statut :</strong> <span class="capitalize">${order.status}</span></p>
          <p><strong>Heure :</strong> ${order.pickupTime || '-'}</p>
        </div>
        <div class="flex gap-2">
          <button class="bg-orange-600 hover:bg-yellow text-white px-3 py-1 rounded" onclick="openOrderDetail('${order._id}')">Détails</button>
          <button class="bg-black hover:bg-yellow-600 text-white px-3 py-1 rounded" onclick="toggleTimeline('${order._id}', '${order.status}')">Suivre</button>
        </div>
      </div>
      <div id="timeline-${order._id}" class="mt-4 hidden"></div>
    `;

    container.appendChild(div);
  });
}

function toggleTimeline(orderId, status) {
  const timelineEl = document.getElementById(`timeline-${orderId}`);
  const isVisible = !timelineEl.classList.contains('hidden');

  if (isVisible) {
    timelineEl.classList.add('hidden');
    timelineEl.innerHTML = '';
  } else {
    updateTimeline(orderId, status);
    timelineEl.classList.remove('hidden');
  }
}

function updateTimeline(orderId, status) {
  const steps = ["reçue", "en préparation", "prête", "livrée"];
  const timelineEl = document.getElementById(`timeline-${orderId}`);

  const html = steps.map(step => {
    const active = steps.indexOf(step) <= steps.indexOf(status);
    return `
      <div class="mb-2 relative pl-6 ${active ? 'text-black font-semibold' : 'text-gray-400'}">
        <div class="absolute -left-3 top-1 w-3 h-3 rounded-full ${active ? 'bg-yellow-500' : 'bg-gray-300'}"></div>
        ${step}
      </div>
    `;
  }).join('');

  timelineEl.innerHTML = html;
}


socket.on('order-status-updated', data => {
  if (data.orderId && data.status) {
    updateTimeline(data.orderId, data.status);
  }
});



    // Modal commande avec gestion fermeture améliorée
    function openOrderDetail(id) {
      currentOrder = userOrders.find(o => o._id === id);
      if (!currentOrder) return alert("Commande non trouvée");

      if (document.getElementById('orderModal')) {
        document.getElementById('orderModal').remove(); // Supprime modal existante avant d'en créer une nouvelle
      }

      const modalHtml = `
      <div id="orderModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white w-11/12 max-w-3xl rounded shadow-lg p-6 relative max-h-[80vh] overflow-auto">
          <button id="closeModalBtn" class="absolute top-2 right-3 text-gray-600 text-3xl font-bold hover:text-gray-900">&times;</button>
          <h2 class="text-2xl font-bold mb-4">Commande #${currentOrder.orderId || currentOrder._id}</h2>
          <p><strong>Nom :</strong> ${currentOrder.customerName || '-'}</p>
          <p><strong>Téléphone :</strong> ${currentOrder.customerPhone || '-'}</p>
          <p><strong>Heure :</strong> ${currentOrder.pickupTime || '-'}</p>
          <p><strong>Statut :</strong> <span class="capitalize">${currentOrder.status}</span></p>
          <p class="mt-4 font-semibold">Plats :</p>
          <ul class="list-disc ml-5 mb-4">${(currentOrder.items || []).map(i => `<li>${i.name} × ${i.quantity} (${i.price.toFixed(2)}€)</li>`).join('')}</ul>

          <button id="cancelOrderBtn" class="mb-4 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">Annuler la commande</button>

          <div>
            <h3 class="font-semibold mb-2">Chat avec l’admin</h3>
            <div id="chatWindow" class="border p-3 rounded h-40 overflow-auto mb-2 bg-gray-50"></div>
            <textarea id="chatInput" rows="2" class="w-full border p-2 rounded" placeholder="Écrire un message…"></textarea>
            <button id="sendChatBtn" class="mt-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Envoyer</button>
          </div>
        </div>
      </div>
      `;

      document.body.insertAdjacentHTML('beforeend', modalHtml);

      // Gestion fermeture modal
      const modal = document.getElementById('orderModal');
      const closeBtn = document.getElementById('closeModalBtn');
      const cancelBtn = document.getElementById('cancelOrderBtn');
      const sendChatBtn = document.getElementById('sendChatBtn');

      closeBtn.onclick = closeOrderDetail;
      cancelBtn.onclick = cancelOrder;
      sendChatBtn.onclick = sendChat;

      // Fermer modal au clic hors contenu
      modal.onclick = (e) => {
        if (e.target === modal) closeOrderDetail();
      };

      // Fermer modal à la touche Échap
      document.addEventListener('keydown', escHandler);

      // Join order chat room
      socket.emit('joinOrder', currentOrder.orderId || currentOrder._id);

      // Clear chat window
      document.getElementById('chatWindow').innerHTML = '';
    }

    function closeOrderDetail() {
      const modal = document.getElementById('orderModal');
      if (modal) modal.remove();
      currentOrder = null;
      document.removeEventListener('keydown', escHandler);
    }

    function escHandler(e) {
      if (e.key === "Escape") {
        closeOrderDetail();
      }
    }

    async function cancelOrder() {
      if (!confirm("Voulez-vous vraiment annuler cette commande ?")) return;
      if (!currentOrder) return alert("Aucune commande sélectionnée");

      const createdAt = new Date(currentOrder.createdAt);
      const now = new Date();
      const diffMinutes = (now - createdAt) / 60000;

      if (diffMinutes > 2) {
        return alert("Délai d’annulation dépassé (2 minutes).");
      }

      try {
        const res = await fetch(`${API_BASE}/orders/${currentOrder.orderId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          }
        });

        if (!res.ok) {
          alert('Erreur lors de l’annulation.');
          return;
        }

        alert('Commande annulée.');
        closeOrderDetail();
        await fetchOrders();
      } catch (e) {
        console.error('Erreur cancelOrder:', e);
        alert('Erreur lors de l’annulation.');
      }
    }



    function sendChat() {
      const msgInput = document.getElementById('chatInput');
      const msg = msgInput.value.trim();
      if (!msg || !currentOrder) return;
      socket.emit('clientMessage', { orderId: currentOrder.orderId || currentOrder._id, text: msg });
      appendChat('Moi', msg);
      msgInput.value = '';
    }

    function appendChat(sender, message) {
      const win = document.getElementById('chatWindow');
      if (!win) return;
      const msgDiv = document.createElement('div');
      msgDiv.className = 'mb-1';
      msgDiv.innerHTML = `<strong>${sender} :</strong> ${message}`;
      win.appendChild(msgDiv);
      win.scrollTop = win.scrollHeight;
    }

    socket.on('newAdminMessage', data => {
      if (currentOrder && (data.orderId === currentOrder.orderId || data.orderId === currentOrder._id)) {
        appendChat('Admin', data.text);
      }
    });

    // test notif
    const currentUserId = localStorage.getItem('userId');
    const currentUserRole = localStorage.getItem('role');


    socket.emit('register', {
      userId: currentUserId,
      role: currentUserRole
    });

    socket.on('new_notification', notification => {
      console.log('🔔 Nouvelle notification :', notification.message);

      const container = document.getElementById('notifications-container');
      if (container) {
        const notifEl = document.createElement('div');
        notifEl.className = 'notification-item bg-blue-100 p-2 mb-1 rounded shadow-sm';
        notifEl.textContent = notification.message;
        container.prepend(notifEl);
      }
    });



    // fin test
    // Upload photo de profil - preview locale
    document.getElementById('profilePhoto').addEventListener('change', function () {
      const file = this.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        document.getElementById('profilePhotoPreview').src = e.target.result;
        document.getElementById('profilePhotoPreview').classList.remove('hidden');
        document.getElementById('profilePhotoPlaceholder').classList.add('hidden');
      };
      reader.readAsDataURL(file);
    });

    // Soumission formulaire profil (upload + champs)
    document.getElementById('profileForm').addEventListener('submit', async e => {
      e.preventDefault();
      const form = e.target;
      const formData = new FormData();

      const username = form.username.value.trim();
      const email = form.email.value.trim();
      const password = form.password.value.trim();
      const photoFile = form.profilePhoto.files[0];

      if (!username || !email) {
        alert('Nom et email obligatoires');
        return;
      }

      formData.append('username', username);
      formData.append('email', email);
      if (password) formData.append('password', password);
      if (photoFile) formData.append('photo', photoFile);

      try {
        const res = await fetch(`${API_BASE}/users/me`, {
          method: 'PUT',
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` },
          body: formData
        });
        if (!res.ok) {
      alert('Erreur mise à jour : ' + (error.message || res.statusText));
          return;
        }
        const updatedUser = await res.json();
    userData = updatedUser;
    updateProfileUI();
    document.getElementById('profileMsg').textContent = 'Profil mis à jour avec succès.';
    setTimeout(() => {
      document.getElementById('profileMsg').textContent = '';
    }, 3000);
  } catch (e) {
    console.error('Erreur update profile:', e);
    alert('Erreur serveur lors de la mise à jour du profil.');
  }
    });

    // Déconnexion simple
    function logout() {
      localStorage.removeItem('token');
      window.location.href = '/login-user.html';
    }

    // Initialisation
    (async () => {
      if (!localStorage.getItem('token')) {
        logout();
        return;
      }
      await fetchUser();
      await fetchOrders();
    })();

    // ⚡ Réception des notifications en temps réel
    socket.on('new_notification', data => {
      displayNotification(data);
    });

    function displayNotification({ title, message, timestamp }) {
      const notif = document.createElement('div');
      notif.className = 'bg-green-100 border border-green-300 text-green-800 px-4 py-2 rounded shadow';
      notif.innerHTML = `
    <strong>${title}</strong><br/>
    <span>${message}</span><br/>
    <small class="text-xs text-gray-500">${new Date(timestamp).toLocaleTimeString()}</small>
  `;
      document.getElementById('notifications-container').prepend(notif);

      // Auto suppression après 10 sec (optionnel)
      setTimeout(() => notif.remove(), 10000);
    }

    const notificationButton = document.getElementById('notificationButton');
    const notificationCount = document.getElementById('notificationCount');
    const notificationList = document.getElementById('notificationList');
    const notificationsContainer = document.getElementById('notifications-container');

    let notifications = [];
    let unreadCount = 0;

    // Toggle d'affichage de la liste
    notificationButton.addEventListener('click', () => {
      notificationList.classList.toggle('hidden');

      // Marque les notifications comme lues
      if (!notificationList.classList.contains('hidden')) {
        unreadCount = 0;
        notificationCount.classList.add('hidden');
        updateNotificationUI(); // Met à jour l'apparence des éléments
      }
    });

    // Réception des notifications via socket
    socket.on('notification', (data) => {
      const notification = {
        message: data.message || 'Nouvelle notification',
        timestamp: new Date().toLocaleTimeString(), // ou data.timestamp si dispo
        read: false
      };

      notifications.unshift(notification);
      unreadCount++;
      updateNotificationUI();
    });

    // Mise à jour de l'interface
    function updateNotificationUI() {
      // Met à jour le badge de la cloche
      if (unreadCount > 0) {
        notificationCount.textContent = unreadCount;
        notificationCount.classList.remove('hidden');
      }

      // Mise à jour de la liste des notifications
      notificationsContainer.innerHTML = '';

      if (notifications.length === 0) {
        const li = document.createElement('li');
        li.className = 'px-3 py-2 text-gray-500 text-sm';
        li.textContent = 'Aucune notification.';
        notificationsContainer.appendChild(li);
        return;
      }

      notifications.forEach((notif) => {
        const li = document.createElement('li');
        li.className = `px-3 py-2 text-sm border-b ${notif.read ? 'text-gray-600' : 'text-gray-800 font-medium bg-gray-100'}`;

        const message = document.createElement('div');
        message.textContent = notif.message;

        const time = document.createElement('div');
        time.className = 'text-xs text-gray-400';
        time.textContent = notif.timestamp;

        li.appendChild(message);
        li.appendChild(time);
        notificationsContainer.appendChild(li);
      });

      // Marquer toutes les notifications comme lues
      notifications.forEach(n => n.read = true);
    }

  </script>

</body>

</html>